name: CD - Deploy to Hetzner

# Solo ejecutar en push a main y permitir ejecuci√≥n manual
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deploy?'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: read

jobs:
  # Verificar que CI pas√≥ antes de deploy
  verify-ci:
    name: Verify CI Status
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' }}

    steps:
      - name: Wait for CI to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Lint, Test & Build'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [verify-ci]
    if: |
      always() &&
      (needs.verify-ci.result == 'success' || needs.verify-ci.result == 'skipped')

    timeout-minutes: 20

    environment:
      name: production

    env:
      APP_URL: ${{ secrets.APP_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add Hetzner host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Hetzner
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'ENDSSH'
            set -e

            echo "üöÄ Starting deployment to Hetzner..."

            # Navegar al directorio de la aplicaci√≥n
            cd /opt/clousadmin || exit 1
            # Hacer backup del .env actual
            echo "üì¶ Backing up .env file..."
            BACKUP_NAME=".env.backup.$(date +%Y%m%d_%H%M%S)"
            cp .env "$BACKUP_NAME"

            # Pull latest changes
            echo "üì• Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main

            # Restaurar .env
            echo "üîê Restoring .env file..."
            if [ -f "$BACKUP_NAME" ]; then
              cp "$BACKUP_NAME" .env
            else
              latest_backup=$(ls -t .env.backup.* 2>/dev/null | head -1 || true)
              if [ -n "$latest_backup" ]; then
                echo "‚ö†Ô∏è Backup original no encontrado, usando $latest_backup"
                cp "$latest_backup" .env
              else
                echo "‚ö†Ô∏è No backup .env disponible, manteniendo .env actual"
              fi
            fi

            # Install dependencies
            echo "üì¶ Installing dependencies..."
            npm ci --production=false

            # Generate Prisma Client
            echo "üîß Generating Prisma Client..."
            npx prisma generate

            # Run migrations
            echo "üóÑÔ∏è Running database migrations..."
            npx prisma migrate deploy

            # Build application
            echo "üèóÔ∏è Building application..."
            NODE_OPTIONS="--max-old-space-size=8192" npm run build

            # Verificar artefactos de build ANTES de reiniciar
            echo "üîç Verifying build artifacts..."
            if [ ! -f ".next/BUILD_ID" ]; then
              echo "‚ùå Build failed: .next/BUILD_ID not found"
              exit 1
            fi

            if [ ! -d ".next/server" ]; then
              echo "‚ùå Build failed: .next/server directory not found"
              exit 1
            fi

            # Verificar que hay archivos en .next/server
            SERVER_FILES=$(find .next/server -type f 2>/dev/null | wc -l)
            if [ "$SERVER_FILES" -eq "0" ]; then
              echo "‚ùå Build failed: No server files found in .next/server"
              exit 1
            fi

            echo "‚úÖ Build artifacts verified"
            echo "üì¶ Build ID: $(cat .next/BUILD_ID)"
            echo "üì¶ Server files: $SERVER_FILES"

            # Restart PM2
            echo "‚ôªÔ∏è Restarting application..."
            pm2 restart clousadmin || pm2 start npm --name clousadmin -- start
            pm2 save

            # Verificar que la app est√° corriendo
            echo "‚úÖ Verifying application is running..."
            pm2 list

            # Esperar un momento para que PM2 detecte si hay errores inmediatos
            sleep 3

            # Verificar que no hay errores inmediatos en PM2
            if pm2 list | grep "clousadmin" | grep -q "errored"; then
              echo "‚ùå Application errored immediately after start"
              pm2 logs clousadmin --lines 100 --nostream
              exit 1
            fi

            # Limpiar backups antiguos (mantener √∫ltimos 5)
            echo "üßπ Cleaning old backups..."
            ls -t .env.backup.* 2>/dev/null | tail -n +6 | xargs -r rm

            echo "‚úÖ Deployment completed successfully!"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."

          # Esperar 15 segundos para que la app se reinicie completamente
          echo "‚è≥ Waiting for application to start..."
          sleep 15

          # Asegurar que usamos HTTPS (nginx redirige HTTP->HTTPS con 308)
          HEALTH_URL="${{ secrets.APP_URL }}/api/health"
          # Si la URL no empieza con https://, agregarla
          if [[ ! "$HEALTH_URL" =~ ^https?:// ]]; then
            HEALTH_URL="https://$HEALTH_URL"
          fi
          # Forzar HTTPS si se puso HTTP
          HEALTH_URL="${HEALTH_URL/http:/https:}"

          echo "üîç Checking: $HEALTH_URL"

          # Verificar que la app responde (seguir redirects con -L)
          http_code=$(curl -L -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Application is responding correctly (HTTP $http_code)"

            # Verificar que la respuesta JSON es v√°lida
            health_response=$(curl -L -s "$HEALTH_URL")
            echo "üìä Health check response: $health_response"

            # Verificar que el JSON contiene "healthy": true
            if echo "$health_response" | grep -q '"healthy":true'; then
              echo "‚úÖ Application is healthy"
            else
              echo "‚ö†Ô∏è Application responded but is not healthy"
              echo "Response: $health_response"
              echo "üìã Checking application logs..."
              ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} "pm2 logs clousadmin --lines 50 --nostream"
              exit 1
            fi
          else
            echo "‚ùå Application returned HTTP $http_code"
            echo "üìã Checking application logs..."
            ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} "pm2 logs clousadmin --lines 100 --nostream"
            echo "üìã Checking PM2 status..."
            ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} "pm2 status"
            echo "üìã Checking if .next directory exists..."
            ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} "ls -la /opt/clousadmin/.next/ | head -20"
            exit 1
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to production completed successfully"
            echo "üåê Application URL: ${{ secrets.APP_URL }}"
          else
            echo "‚ùå Deployment failed - check logs above"
            exit 1
          fi

  # Rollback autom√°tico si el deploy falla
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: ${{ needs.deploy.result == 'failure' }}

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add Hetzner host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Perform rollback
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'ENDSSH'
            set -e

            echo "‚ö†Ô∏è Deployment failed - performing rollback..."

            cd /opt/clousadmin || exit 1
            # Volver al commit anterior
            git reset --hard HEAD~1

            # Restaurar √∫ltimo .env
            latest_backup=$(ls -t .env.backup.* 2>/dev/null | head -1)
            if [ -n "$latest_backup" ]; then
              cp "$latest_backup" .env
            fi

            # Reinstalar dependencias
            npm ci --production=false
            npx prisma generate

            # Rebuild
            NODE_OPTIONS="--max-old-space-size=8192" npm run build

            # Restart
            pm2 restart clousadmin

            echo "‚úÖ Rollback completed"
          ENDSSH

      - name: Notify rollback
        if: always()
        run: |
          echo "üîÑ Rollback completed - application reverted to previous version"
          echo "‚ö†Ô∏è Please check the deployment logs and fix the issues before trying again"
