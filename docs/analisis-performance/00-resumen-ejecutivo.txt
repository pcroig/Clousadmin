â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 ANÃLISIS EXHAUSTIVO DE MODELOS DE DATOS                    â•‘
â•‘                    Clousadmin - Problemas de Performance                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

HALLAZGOS PRINCIPALES:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š PROBLEMAS N+1 CRÃTICOS DETECTADOS:

1. ğŸ”´ BOLSA DE HORAS (app/api/fichajes/bolsa-horas/route.ts)
   Impacto: ~16,500 queries innecesarias
   â””â”€ Loop sobre 500 empleados Ã— 33 queries/empleado
   SoluciÃ³n: Usar batch calcularBalanceMensualBatch()
   Mejora: 99.7% reducciÃ³n (16,500 â†’ ~50 queries)

2. ğŸ”´ REVISIÃ“N DE FICHAJES (app/api/fichajes/revision/route.ts)
   Impacto: ~100 queries N+1
   â””â”€ Promise.all().map() con findUnique dentro
   SoluciÃ³n: Precarguar fichajes con findMany
   Mejora: 95% reducciÃ³n (100 â†’ ~5 queries)

3. ğŸ”´ EVENTOS DE NÃ“MINA (app/api/nominas/eventos/route.ts)
   Impacto: ~12 queries N+1
   â””â”€ Loop sobre eventos consultando compensaciones
   SoluciÃ³n: Query agregada Ãºnica
   Mejora: 85% reducciÃ³n (12 â†’ 1 query)

4. ğŸŸ¡ BALANCE DE HORAS (lib/calculos/balance-horas.ts)
   Impacto: 30 queries por empleado por perÃ­odo
   â””â”€ Loop sobre diasDelPeriodo con esDiaLaborable()
   SoluciÃ³n: Batch processing o cacheo
   Mejora: 50% reducciÃ³n (30+ â†’ 5-10 queries)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ˆ QUERIES MÃS COMUNES Y SU ESTADO:

âœ… API FICHAJES (/api/fichajes)
   â””â”€ Query principal bien optimizada con SELECT
   â””â”€ Carga 500 max, eventos incluidos
   â””â”€ Relaciones: empleado (con select), eventos

âœ… API AUSENCIAS (/api/ausencias)
   â””â”€ Bien optimizado con SELECT
   â””â”€ Carga empleado con datos parciales
   â””â”€ Relaciones: empleado, documento (opcional)

âš ï¸ API NÃ“MINAS - ANALYTICS (/api/nominas/analytics)
   â””â”€ Carga masiva de complementos y equipos
   â””â”€ Bien optimizado pero puede simplificarse
   â””â”€ Relaciones: empleado, equipo, complementos

âœ… API EMPLEADOS (/api/empleados)
   â””â”€ Bien optimizado con SELECT
   â””â”€ Carga usuario, manager, puesto, equipos
   â””â”€ Estado: OptimizaciÃ³n buena

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š CAMPOS JSONB IDENTIFICADOS:

Campo              Modelo                  Frecuencia  Problema
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
config             Jornada                 ALTA        Sin Ã­ndice, muy usado
config             Empresa                 MEDIA       Sin Ã­ndice
config             Integracion             MEDIA       Contiene credentials
datosExtraidos     Documento               BAJA        IA extraction
revisionIA         Ausencia                MEDIA       AnÃ¡lisis IA
datosTemporales    OnboardingEmpleado      BAJA        Temporal
camposCompletados  DocumentoGenerado       BAJA        Tracking

ğŸ”§ SOLUCIÃ“N: Jornada.config se carga en CADA fichaje
   â””â”€ Usar SELECT explÃ­cito o precachear en Redis
   â””â”€ O agregar Ã­ndice JSONB en Postgres

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ—ï¸ ÃNDICES FALTANTES:

Modelo                    Ãndice Faltante
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Empleado                  @@index([empresaId, activo])
FichajeEvento             @@index([fichajeId, tipo])
FichajeEvento             @@index([tipo, hora])
Nomina                    @@index([empresaId, estado])
Nomina                    @@index([mes, anio, estado])
EventoNomina              @@index([estado])
AutoCompletado            @@index([createdAt])
CompensacionHoraExtra     @@index([createdAt, estado]) ğŸ”´ CRÃTICO
CompensacionHoraExtra     @@index([empresaId, estado])

Impacto estimado: 15% mejora en queries de filtrado

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”„ CAMPOS CALCULADOS SIN CACHEO:

1. Balance de Horas
   â””â”€ Se recalcula cada vez (30+ queries)
   â””â”€ SoluciÃ³n: Tabla ResumenBalanceMensualFichaje
   â””â”€ Invalidar on fichaje.create/update

2. Resumen Mensual de NÃ³mina
   â””â”€ Modelo ResumenMensualNomina existe
   â””â”€ Â¿Se usa? Verificar si se calcula automÃ¡ticamente

3. Saldo de Ausencias (EmpleadoSaldoAusencias)
   â””â”€ âœ… Ya cacheado y bien optimizado

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš€ MODELO EMPLEADO (AnÃ¡lisis de Relaciones):

Empleado tiene 28+ RELACIONES:

Core (âœ… Necesarias):
  - usuario (1:1)
  - manager (1:1 self-ref)
  - empleadosACargo (1:N self-ref)
  - jornada, puesto, equipos

Time Tracking (âœ…):
  - ausencias, fichajes

Payroll (âœ…):
  - contratos, nominas, complementos

Documents (âœ…):
  - documentos, carpetas

Workflow (âš ï¸ Muchas):
  - solicitudesCambio, autoCompletados, firmas
  - invitacion, onboarding
  - preferenciasVacaciones
  - alertasNomina, resumenesNomina, compensacionesHoras
  - consentimientos, denuncias
  - documentosGenerados
  - solicitudesCorreccionFichaje

âš ï¸ RECOMENDACIÃ“N: SIEMPRE usar SELECT cuando queries Empleado
   âŒ const emp = prisma.empleado.findUnique({where: {id}})
   âœ… const emp = prisma.empleado.findUnique({
        where: {id}, 
        select: {id, nombre, email, ...}
      })

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ PLAN DE ACCIÃ“N:

SEMANA 1 - CRÃTICO (3 problemas N+1):
â”œâ”€ [3h] Implementar calcularBalanceMensualBatch()
â”œâ”€ [2h] Optimizar revisiÃ³n de fichajes (precarga)
â”œâ”€ [1.5h] Resolver eventos de nÃ³mina (query agregada)
â””â”€ Impacto esperado: 95% reducciÃ³n en queries crÃ­ticas

SEMANA 2 - ÃNDICES Y CACHEO:
â”œâ”€ [0.5h] Agregar Ã­ndices faltantes
â”œâ”€ [4h] Implementar cache balance horas
â”œâ”€ [2h] Optimizar jornada.config (Redis/Ã­ndice)
â””â”€ Impacto esperado: 15-50% mejora adicional

SEMANA 3 - MEJORAS ARQUITECTÃ“NICAS:
â”œâ”€ Considerar split Empleado en mÃºltiples modelos
â”œâ”€ Implementar lazy loading
â””â”€ Performance testing y validaciÃ³n

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š RESUMEN DE IMPACTO:

ESCENARIO ACTUAL (PEOR CASO):
  Empleados:        500
  PerÃ­odo:          1 mes
  Bolsa de horas:   ~16,500 queries âŒ
  Total potencial:  ~20,000 queries

DESPUÃ‰S DE FIXES (CRÃTICAS):
  Bolsa de horas:   ~50 queries âœ…
  Total potencial:  ~4,000 queries (80% reducciÃ³n)

DESPUÃ‰S DE TODAS LAS MEJORAS:
  Total potencial:  ~500-1,000 queries (95%+ reducciÃ³n)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ARCHIVOS CRÃTICOS A REVISAR:

âœ“ app/api/fichajes/bolsa-horas/route.ts        (LÃ­nea 68-77)
âœ“ app/api/fichajes/revision/route.ts           (LÃ­nea 69-130)
âœ“ app/api/nominas/eventos/route.ts             (LÃ­nea 69-128)
âœ“ lib/calculos/balance-horas.ts                (LÃ­nea 200-208)
âœ“ prisma/schema.prisma                         (Agregar Ã­ndices)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

DOCUMENTACIÃ“N GENERADA:

ğŸ“„ 1. analisis_datos_models.md
   â””â”€ AnÃ¡lisis exhaustivo (7,000+ palabras)
   â””â”€ Patrones de queries, N+1, JSONB, Ã­ndices, relaciones, cacheo

ğŸ“„ 2. soluciones_codigo.md
   â””â”€ Ejemplos de cÃ³digo implementables
   â””â”€ Soluciones para cada problema
   â””â”€ Scripts de migraciÃ³n

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
