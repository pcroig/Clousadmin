#!/bin/bash
# Script de verificaci√≥n de malware
# Ejecutar en el servidor para verificar que no ha vuelto

echo "üîç VERIFICACI√ìN DE MALWARE - $(date)"
echo "=========================================="
echo ""

# 1. Verificar crontab
echo "1Ô∏è‚É£ Verificando crontab..."
if crontab -l 2>/dev/null | grep -E 'ellison|80.64|x86|redistribution|80.64.16.241' > /dev/null; then
    echo "‚ùå MALWARE DETECTADO EN CRONTAB"
    crontab -l | grep -E 'ellison|80.64|x86|redistribution'
    exit 1
else
    echo "‚úÖ Crontab limpio"
fi
echo ""

# 2. Verificar servicios systemd maliciosos
echo "2Ô∏è‚É£ Verificando servicios systemd..."
SERVICIOS_SOSPECHOSOS=$(systemctl list-units --all 2>/dev/null | grep -E 'bot|x86|monitor-x86|systemd-x86|redistribution' || true)
if [ -n "$SERVICIOS_SOSPECHOSOS" ]; then
    echo "‚ùå SERVICIOS SOSPECHOSOS DETECTADOS:"
    echo "$SERVICIOS_SOSPECHOSOS"
    exit 1
else
    echo "‚úÖ No hay servicios maliciosos"
fi
echo ""

# 3. Verificar scripts de inicio
echo "3Ô∏è‚É£ Verificando scripts de inicio..."
if [ -f /etc/init.d/S99x86 ] || [ -f /etc/init.d/redistribution ]; then
    echo "‚ùå SCRIPTS MALICIOSOS DETECTADOS"
    [ -f /etc/init.d/S99x86 ] && echo "  - /etc/init.d/S99x86 existe"
    [ -f /etc/init.d/redistribution ] && echo "  - /etc/init.d/redistribution existe"
    exit 1
else
    echo "‚úÖ No hay scripts maliciosos en /etc/init.d/"
fi
echo ""

# 4. Verificar rc.local
echo "4Ô∏è‚É£ Verificando /etc/rc.local..."
if grep -E 'ellison|80.64|x86|redistribution' /etc/rc.local 2>/dev/null > /dev/null; then
    echo "‚ùå C√ìDIGO MALICIOSO EN /etc/rc.local"
    grep -E 'ellison|80.64|x86|redistribution' /etc/rc.local
    exit 1
else
    echo "‚úÖ rc.local limpio"
fi
echo ""

# 5. Verificar ld.so.preload
echo "5Ô∏è‚É£ Verificando /etc/ld.so.preload..."
if [ -s /etc/ld.so.preload ] && ! grep -q '^$' /etc/ld.so.preload; then
    echo "‚ö†Ô∏è  ld.so.preload tiene contenido:"
    cat /etc/ld.so.preload
    echo "Revisar manualmente si es leg√≠timo"
else
    echo "‚úÖ ld.so.preload vac√≠o (correcto)"
fi
echo ""

# 6. Verificar procesos sospechosos
echo "6Ô∏è‚É£ Verificando procesos sospechosos..."
PROCESOS_SOSPECHOSOS=$(ps aux | grep -E 'ellison|80.64|x86|redistribution' | grep -v grep || true)
if [ -n "$PROCESOS_SOSPECHOSOS" ]; then
    echo "‚ùå PROCESOS SOSPECHOSOS EN EJECUCI√ìN:"
    echo "$PROCESOS_SOSPECHOSOS"
    exit 1
else
    echo "‚úÖ No hay procesos maliciosos ejecut√°ndose"
fi
echo ""

# 7. Verificar conexiones de red sospechosas
echo "7Ô∏è‚É£ Verificando conexiones de red..."
CONEXIONES_SOSPECHOSAS=$(netstat -antp 2>/dev/null | grep -E 'ellison|80.64.16.241' || ss -antp 2>/dev/null | grep -E 'ellison|80.64.16.241' || true)
if [ -n "$CONEXIONES_SOSPECHOSAS" ]; then
    echo "‚ö†Ô∏è  CONEXIONES SOSPECHOSAS DETECTADAS:"
    echo "$CONEXIONES_SOSPECHOSAS"
else
    echo "‚úÖ No hay conexiones sospechosas"
fi
echo ""

# 8. Verificar uso de CPU (posible miner√≠a)
echo "8Ô∏è‚É£ Verificando uso de CPU..."
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
    echo "‚ö†Ô∏è  USO DE CPU ALTO: ${CPU_USAGE}%"
    echo "   Revisar procesos con: top"
else
    echo "‚úÖ Uso de CPU normal: ${CPU_USAGE}%"
fi
echo ""

# 9. Verificar protecci√≥n del crontab
echo "9Ô∏è‚É£ Verificando protecci√≥n del crontab..."
if lsattr /var/spool/cron/crontabs/root 2>/dev/null | grep -q '\----i'; then
    echo "‚úÖ Crontab protegido con chattr +i"
else
    echo "‚ö†Ô∏è  Crontab NO est√° protegido"
    echo "   Ejecutar: chattr +i /var/spool/cron/crontabs/root"
fi
echo ""

echo "=========================================="
echo "‚úÖ VERIFICACI√ìN COMPLETA"
echo "Si todos los checks pasaron, el sistema est√° limpio."
echo ""
echo "‚ö†Ô∏è  RECOMENDACIONES:"
echo "1. Cambiar contrase√±a de root"
echo "2. Cambiar claves SSH"
echo "3. Instalar fail2ban"
echo "4. Cambiar puerto SSH a no-est√°ndar"
echo "5. Deshabilitar login root (usar usuario con sudo)"

